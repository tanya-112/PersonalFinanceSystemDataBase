1.
/*Обновление значения поля ВесьКапитал пользователя в табл.Аккаунты
после создания пользователем нового счета*/
create trigger [dbo].[Т_Аккаунты.ВесьКапиталInsert]
on [dbo].[Счета] 
after insert 
as 
begin
update Аккаунты set ВесьКапитал=ВесьКапитал+inserted.Сумма
from inserted inner join Аккаунты on inserted.КодАккаунта=Аккаунты.КодАккаунта
end








2.

/*Обновление значения поля ВесьКапитал пользователя в табл.Аккаунты
после обновления значения Счета.Сумма у текущего пользователя*/
create trigger [dbo].[Т_Аккаунты.ВесьКапиталUpdate]
on [dbo].[Счета] 
after update
as 
begin
if update(Сумма)/*Можно записать как update(Сумма или КодАккаунта), но предполагается,
что в разработанном приложении текущий КодАккаунта не может так просто быть измененным 
на КодАккаунта другого пользователя, т.к. приложение должно автоматически высылать 
код именно того аккаунта, с которого совершают действие, т.е. код сейчас авторизованного пользователя */
declare @a int
set @a= inserted.КодАккаунта /*В чем ОШИБКА????????Не удалось привязать составной идентификатор "inserted.КодАккаунта"!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
(ну а вообще в дальнейшем задавать КодАккаунта не нужно будет,
т.к. предполагается разработать приложение таким образом, чтобы оно само автоматически высылало код именно того аккаунта, 
с которого совершают действие, т.е. код авторизованного в данный момент пользователя)
*/
declare @Капитал money
exec ПодсчетТекущегоКапитала @a, @Капитал output/*тут вызов хранимой процедуры*/
update Аккаунты set ВесьКапитал=@Капитал
from inserted inner join Аккаунты on inserted.КодАккаунта=Аккаунты.КодАккаунта
end



3.

/*Обновление значения поля ВесьКапитал пользователя в табл.Аккаунты
после удаления пользователем одного из своих счетов*/
create trigger [dbo].[Т_Аккаунты.ВесьКапиталDelete]
on [dbo].[Счета] 
after delete
as 
begin
update Аккаунты set ВесьКапитал=ВесьКапитал-deleted.Сумма
from deleted inner join Аккаунты on deleted.КодАккаунта=Аккаунты.КодАккаунта
end



4.

/*Обновление значения поля Счета.Сумма
после создания пользователем нового дохода*/
create trigger [dbo].[Т_Счета.СуммаInsertДоход]
on [dbo].[Доходы] 
after insert 
as 
begin
update Счета set Сумма=Счета.Сумма+inserted.Сумма
from inserted inner join Счета on inserted.КодСчета=Счета.КодСчета
end



5.

/*Обновление значения поля Счета.Сумма
после создания пользователем нового расхода*/
create trigger [dbo].[Т_Счета.СуммаInsertРасход]
on [dbo].[Расходы] 
after insert 
as 
begin
update Счета set Сумма=Счета.Сумма-inserted.Сумма
from inserted inner join Счета on inserted.КодСчета=Счета.КодСчета
end



6.

 /*СИНТАКСИЧЕСКИЕ ОШИБКИ!!!


Обновление значения поля Счета.Сумма
после редактирования пользователем существующего дохода*/
create trigger [dbo].[Т_Счета.СуммаUpdateДоход]
on [dbo].[Доходы] 
after update
as 
begin
if update(Сумма) 
if inserted.Сумма>deleted.Сумма from inserted inner join deleted on inserted.КодДохода=deleted.КодДохода
update Счета set Сумма=Счета.Сумма+abs(inserted.Сумма-deleted.Сумма)
else update Счета set Сумма=Счета.Сумма-abs(inserted.Сумма-deleted.Сумма)
from inserted inner join Счета on inserted.КодСчета=Счета.КодСчета
end


7. СДЕЛАТЬ АНАЛОГИЧНО 6-МУ ДЛЯ РАСХОДОВ!!!!!!!!!!!!!




8. 

/*Обновление значения поля Счета.Сумма 
после удаления пользователем одного из своих доходов*/
create trigger [dbo].[Т_Счета.ДоходыDelete]
on [dbo].[Доходы] 
after delete
as 
begin
update Счета set Сумма=Счета.Сумма-deleted.Сумма
from deleted inner join Счета on deleted.КодСчета=Счета.КодСчета
end




9.

/*Обновление значения поля Счета.Сумма 
после удаления пользователем одного из своих расходов*/
create trigger [dbo].[Т_Счета.РасходыDelete]
on [dbo].[Расходы] 
after delete
as 
begin
update Счета set Сумма=Счета.Сумма+deleted.Сумма
from deleted inner join Счета on deleted.КодСчета=Счета.КодСчета
end


________________________________


10.


create trigger [dbo].[T_вАрхивДоходов]
on [dbo].[Доходы]
after delete
as
begin 
insert into АрхивДоходов(КодДохода,Сумма, Дата, Комментарий,КодСчета,КодПодкатегории, ДатаУдаления, ПричинаУдаления)
select(КодДохода, Сумма, Дата, Комментарий, КодСчета, КодПодкатегории, getdate(),'КАК ТУТ ПОЛУЧАТЬ ПРИЧИНУ ОТ ПОЛЬЗОВАТЕЛЯ?')from deleted
end


11. СДЕЛАТЬ АНАЛОГИЧНО ДЛЯ АРХИВА РАСХОДОВ!!!!



12. ДЛЯ АРХИВА СЧЕТОВ!!!
